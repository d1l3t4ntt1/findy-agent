Parameters:
  EnvBeanstalkApplicationVersionParameter:
    Type: String
    Description: Findy-agent application version
Resources:
  EnvBeanstalkEnvironment:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      EnvironmentName: findy-agent
      ApplicationName: findy-agent
      VersionLabel:
        Ref: EnvBeanstalkApplicationVersionParameter
      SolutionStackName: 64bit Amazon Linux 2018.03 v2.12.17 running Docker 18.06.1-ce
      OptionSettings:
        - Namespace: "aws:autoscaling:launchconfiguration"
          OptionName: IamInstanceProfile
          Value: !Ref EnvInstanceProfile
        - Namespace: "aws:elasticbeanstalk:environment"
          OptionName: EnvironmentType
          Value: SingleInstance
        - Namespace: "aws:autoscaling:asg"
          OptionName: MinSize
          Value: 1
        - Namespace: "aws:autoscaling:asg"
          OptionName: MaxSize
          Value: 1
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: FINDY_DEV_LEDGER_STEWARD_WALLET_NAME
          Value: "{{resolve:secretsmanager:findy-agent:SecretString:findy-agent-dev-ledger-steward-wallet-name}}"
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: FINDY_DEV_LEDGER_STEWARD_WALLET_KEY
          Value: "{{resolve:secretsmanager:findy-agent:SecretString:findy-agent-dev-ledger-steward-wallet-key}}"
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: FINDY_DEV_LEDGER_STEWARD_WALLET_IMPORTED_KEY
          Value: "{{resolve:secretsmanager:findy-agent:SecretString:findy-agent-dev-ledger-steward-wallet-imported-key}}"
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: FINDY_DEV_LEDGER_STEWARD_DID
          Value: "{{resolve:secretsmanager:findy-agent:SecretString:findy-agent-dev-ledger-steward-did}}"
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: FINDY_AGENT_SALT
          Value: "{{resolve:secretsmanager:findy-agent:SecretString:findy-agent-salt}}"
        - Namespace: aws:elasticbeanstalk:application:environment
          OptionName: FINDY_AGENT_HOST_ADDRESS
          Value: "{{resolve:secretsmanager:findy-agent:SecretString:findy-agent-host-address}}"
      Tags:
        - Key: project
          Value: findy
  EnvInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref EnvInstanceProfileRole
  EnvInstanceProfileRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: findy-agent-instance-profile-role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
      Policies:
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: "AllowCloudwatchManagement"
                Effect: "Allow"
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:GetLogEvents"
                  - "logs:PutLogEvents"
                  - "logs:DescribeLogGroups"
                  - "logs:DescribeLogStreams"
                  - "logs:PutRetentionPolicy"
                Resource: "*"
              - Sid: "AllowS3Read"
                Effect: "Allow"
                Action:
                  - "s3:GetObject"
                Resource: "arn:aws:s3:::findy-agent-secrets*/*"
          PolicyName: findy-agent-instance-profile-policy
